import{_ as n,c as a,f as e,o as p}from"./app-BCC5ysrj.js";const t={};function i(l,s){return p(),a("div",null,s[0]||(s[0]=[e(`<h1 id="_9-2-权限管理" tabindex="-1"><a class="header-anchor" href="#_9-2-权限管理"><span>9.2 权限管理</span></a></h1><ul><li><a href="#92-%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86">9.2 权限管理</a><ul><li><a href="#921-%E5%AE%9A%E4%B9%89%E6%9D%83%E9%99%90%E7%9A%84%E6%95%B0%E6%8D%AE%E8%A1%A8">9.2.1 定义权限的数据表</a></li><li><a href="#922-%E7%BB%99model%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9D%83%E9%99%90">9.2.2 给Model添加自定义权限</a><ul><li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9D%83%E9%99%90">自定义权限</a></li></ul></li><li><a href="#923-%E6%9D%83%E9%99%90%E7%9A%84%E6%8E%88%E4%BA%88%E4%B8%8E%E6%A0%A1%E9%AA%8C">9.2.3 权限的授予与校验</a><ul><li><a href="#1-%E7%94%A8%E6%88%B7bbs%E6%9D%83%E9%99%90%E6%93%8D%E4%BD%9C">1. 用户bbs权限操作</a></li><li><a href="#2-%E7%94%A8%E6%88%B7%E7%BB%84bbs%E7%9A%84%E6%9D%83%E9%99%90%E6%93%8D%E4%BD%9C">2. 用户组bbs的权限操作</a></li><li><a href="#3-%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C">3. 用户权限校验</a></li></ul></li></ul></li></ul><p>Django会为应用程序中的每一个Model创建三个默认权限：添加、更改和删除。</p><hr><h2 id="_9-2-1-定义权限的数据表" tabindex="-1"><a class="header-anchor" href="#_9-2-1-定义权限的数据表"><span>9.2.1 定义权限的数据表</span></a></h2><p>Django利用Permission表定义权限：<code>auth_permission</code></p><ul><li>权限与用户的关联表：<code>auth_user_user_permission</code></li><li>权限与用户组的关联表：<code>auth_group_permission</code></li><li>Django的权限时基于Model的。Django提供的是<code>表级别</code>的权限控制</li></ul><h2 id="_9-2-2-给model添加自定义权限" tabindex="-1"><a class="header-anchor" href="#_9-2-2-给model添加自定义权限"><span>9.2.2 给Model添加自定义权限</span></a></h2><ul><li>在定义Model时指定自定义的权限：在Model的Meta中声明</li></ul><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Topic</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        permissions <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token punctuation">(</span><span class="token string">&#39;can_view_topic&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;Can View Topic&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># permissions是一个二元组，第一个元素指定了权限的codename，第二个元素指定了权限的name</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行makemigrations migrate</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">python manage.py makemigrations post</span>
<span class="line">python manage.py migrate</span>
<span class="line"></span>
<span class="line">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from auth_permission where content_type_id <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="自定义权限" tabindex="-1"><a class="header-anchor" href="#自定义权限"><span>自定义权限</span></a></h3><ul><li><p>由于业务的需要，也可以使用代码的形式创建自定义权限，需要执行两个步骤</p><ul><li>获取某个应用的ContentType实例</li><li>给定codename（不能与当前的codename存在重复）和name以及获取的ContentType创建Permission实例</li></ul></li><li><p>例子：给Tipic在添加一个权限</p></li></ul><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">from</span> post<span class="token punctuation">.</span>models <span class="token keyword">import</span> Topic</span>
<span class="line"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> Permission</span>
<span class="line"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>contenttypes<span class="token punctuation">.</span>models <span class="token keyword">import</span> ContentType</span>
<span class="line">codename <span class="token operator">=</span> <span class="token string">&#39;can_publish_topic&#39;</span></span>
<span class="line">name <span class="token operator">=</span> <span class="token string">&#39;Can Publish Topic&#39;</span></span>
<span class="line">content_type <span class="token operator">=</span> ContentType<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_for_model<span class="token punctuation">(</span>Topic<span class="token punctuation">)</span></span>
<span class="line">Permission<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>codename<span class="token operator">=</span>codename<span class="token punctuation">,</span> name<span class="token operator">=</span>name<span class="token punctuation">,</span> content_type<span class="token operator">=</span>content_type<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-2-3-权限的授予与校验" tabindex="-1"><a class="header-anchor" href="#_9-2-3-权限的授予与校验"><span>9.2.3 权限的授予与校验</span></a></h2><p>添加，删除以及清空权限</p><h3 id="_1-用户bbs权限操作" tabindex="-1"><a class="header-anchor" href="#_1-用户bbs权限操作"><span>1. 用户bbs权限操作</span></a></h3><ul><li><p>User实例添加属性需要使用：user_permissions属性，先获取User对象和Permission对象实例</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token punctuation">,</span> Permission</span>
<span class="line">bbs <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">&#39;bbs&#39;</span><span class="token punctuation">)</span></span>
<span class="line">add_topic <span class="token operator">=</span> Permission<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>codename<span class="token operator">=</span><span class="token string">&#39;add_topic&#39;</span><span class="token punctuation">)</span></span>
<span class="line">change_topic <span class="token operator">=</span> Permission<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>codename<span class="token operator">=</span><span class="token string">&#39;change_topic&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>get_all_permissions</code>：查看User对象实例所授予的权限</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">bbs<span class="token punctuation">.</span>get_all_permissions<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><code>user_permissions.set</code>：设置当前用户的权限</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">bbs<span class="token punctuation">.</span>user_permessions<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>add_topic<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><code>user_permissions.add</code>：给User对象在拥有权限的基础上添加权限</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">bbs<span class="token punctuation">.</span>user_permissions<span class="token punctuation">.</span>add<span class="token punctuation">(</span>change_topic<span class="token punctuation">)</span></span>
<span class="line">bbs<span class="token punctuation">.</span>user_permissions<span class="token punctuation">.</span>add<span class="token punctuation">(</span>add_topic<span class="token punctuation">,</span> change_topic<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>user_permissions.remove</code>：删除权限</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">bbs<span class="token punctuation">.</span>user_permissions<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>add_topic<span class="token punctuation">,</span> change_topic<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><code>user_permissions.clear()</code>: 清空权限</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">bbs<span class="token punctuation">.</span>user_permissions<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ul><h3 id="_2-用户组bbs的权限操作" tabindex="-1"><a class="header-anchor" href="#_2-用户组bbs的权限操作"><span>2. 用户组bbs的权限操作</span></a></h3><ul><li><p><code>permissions.set()</code>：给用户组bbs设置权限</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> Group</span>
<span class="line">group_bbs <span class="token operator">=</span> Group<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&#39;bbs&#39;</span><span class="token punctuation">)</span></span>
<span class="line">group_bbs<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>add_topic<span class="token punctuation">,</span> change_topic<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">bbs<span class="token punctuation">.</span>get_all_permissions<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">bbs <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">&#39;bbs&#39;</span><span class="token punctuation">)</span></span>
<span class="line">bbs<span class="token punctuation">.</span>get_all_permissions<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="_3-用户权限校验" tabindex="-1"><a class="header-anchor" href="#_3-用户权限校验"><span>3. 用户权限校验</span></a></h3><ul><li>可以使用User实例的has_perm或has_perms方法</li><li>has_perm：判断用户是否有某一项权限</li><li>has_perms：判断用户是否同时拥有多个权限</li><li>格式 <ul><li>has_perm<code>&lt;app label&gt;.&lt;permission codename&gt;</code><ul><li>app label: 应用名</li><li>permission codename：权限编码</li></ul></li></ul></li><li>返回： <ul><li><p>True：正确</p></li><li><p>False：失败</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">bbs<span class="token punctuation">.</span>has_perm<span class="token punctuation">(</span><span class="token string">&#39;post.add_topic&#39;</span><span class="token punctuation">)</span></span>
<span class="line">bbs<span class="token punctuation">.</span>has_perms<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;post.add_topic&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;post.change_topic&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul>`,23)]))}const c=n(t,[["render",i],["__file","02：权限管理.html.vue"]]),u=JSON.parse('{"path":"/fpython/htmlsystem/Django/chapter-09%EF%BC%9A%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E7%B3%BB%E7%BB%9F/02%EF%BC%9A%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86.html","title":"9.2 权限管理","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"9.2.1 定义权限的数据表","slug":"_9-2-1-定义权限的数据表","link":"#_9-2-1-定义权限的数据表","children":[]},{"level":2,"title":"9.2.2 给Model添加自定义权限","slug":"_9-2-2-给model添加自定义权限","link":"#_9-2-2-给model添加自定义权限","children":[{"level":3,"title":"自定义权限","slug":"自定义权限","link":"#自定义权限","children":[]}]},{"level":2,"title":"9.2.3 权限的授予与校验","slug":"_9-2-3-权限的授予与校验","link":"#_9-2-3-权限的授予与校验","children":[{"level":3,"title":"1. 用户bbs权限操作","slug":"_1-用户bbs权限操作","link":"#_1-用户bbs权限操作","children":[]},{"level":3,"title":"2. 用户组bbs的权限操作","slug":"_2-用户组bbs的权限操作","link":"#_2-用户组bbs的权限操作","children":[]},{"level":3,"title":"3. 用户权限校验","slug":"_3-用户权限校验","link":"#_3-用户权限校验","children":[]}]}],"git":{"updatedTime":1735029308000,"contributors":[{"name":"Linkefou","username":"Linkefou","email":"wlh724567296@163.com","commits":1},{"name":"wanglinhao","username":"wanglinhao","email":"wanglinhao@wegooooo.com","commits":3}]},"filePathRelative":"fpython/htmlsystem/Django/chapter-09：用户认证系统/02：权限管理.md"}');export{c as comp,u as data};
